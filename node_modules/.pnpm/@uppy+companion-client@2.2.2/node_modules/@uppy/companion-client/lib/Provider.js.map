{"version":3,"sources":["Provider.js"],"names":["RequestClient","getName","id","split","map","s","charAt","toUpperCase","slice","join","Provider","constructor","uppy","opts","provider","name","pluginId","tokenKey","companionKeysParams","preAuthToken","headers","Promise","all","getAuthToken","then","token","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","getItem","ensurePreAuth","fetchPreAuthToken","Error","authUrl","queries","URLSearchParams","set","hostname","fileUrl","res","post","err","log","list","directory","get","logout","removeItem","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","companionAllowedHosts","pattern","Array","isArray","RegExp","TypeError","test","companionUrl","replace","URL","origin","tokenStorage"],"mappings":"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","sourcesContent":["'use strict'\n\nimport RequestClient from './RequestClient.js'\nimport * as tokenStorage from './tokenStorage.js'\n\nconst getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nexport default class Provider extends RequestClient {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n  }\n\n  headers () {\n    return Promise.all([super.headers(), this.getAuthToken()])\n      .then(([headers, token]) => {\n        const authHeaders = {}\n        if (token) {\n          authHeaders['uppy-auth-token'] = token\n        }\n\n        if (this.companionKeysParams) {\n          authHeaders['uppy-credentials-params'] = btoa(\n            JSON.stringify({ params: this.companionKeysParams }),\n          )\n        }\n        return { ...headers, ...authHeaders }\n      })\n  }\n\n  onReceiveResponse (response) {\n    response = super.onReceiveResponse(response) // eslint-disable-line no-param-reassign\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  setAuthToken (token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  getAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n  async ensurePreAuth () {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken()\n\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.')\n      }\n    }\n  }\n\n  authUrl (queries = {}) {\n    const params = new URLSearchParams(queries)\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken)\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`\n  }\n\n  fileUrl (id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  async fetchPreAuthToken () {\n    if (!this.companionKeysParams) {\n      return\n    }\n\n    try {\n      const res = await this.post(`${this.id}/preauth/`, { params: this.companionKeysParams })\n      this.preAuthToken = res.token\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning')\n    }\n  }\n\n  list (directory) {\n    return this.get(`${this.id}/list/${directory || ''}`)\n  }\n\n  logout () {\n    return this.get(`${this.id}/logout`)\n      .then((response) => Promise.all([\n        response,\n        this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey),\n      ])).then(([response]) => response)\n  }\n\n  static initPlugin (plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts, ...opts }\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n    /* eslint-enable no-param-reassign */\n  }\n}\n"]}