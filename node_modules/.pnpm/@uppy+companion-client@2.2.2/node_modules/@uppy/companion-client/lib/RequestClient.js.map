{"version":3,"sources":["RequestClient.js"],"names":["fetchWithNetworkError","ErrorWithCause","AuthError","packageJson","stripSlash","url","replace","handleJSONResponse","res","status","jsonPromise","json","errMsg","statusText","errData","message","requestId","Error","Symbol","for","RequestClient","constructor","uppy","opts","skip","response","onReceiveResponse","bind","allowedHeaders","preflightDone","companionHeaders","setCompanionHeaders","headers","hostname","companion","getState","host","companionUrl","Promise","resolve","defaultHeaders","state","has","get","setState","preflight","path","slice","fetch","method","then","split","map","headerName","trim","toLowerCase","catch","err","log","preflightAndHeaders","all","Object","keys","forEach","header","includes","skipPostResponse","credentials","companionCookiesRule","post","data","body","JSON","stringify","delete","test","isAuthError","cause","reject","VERSION","version","Accept"],"mappings":"AAAA;;;;;;;;;;MAEOA,qB;;MACAC,c;;MACAC,S;;MAEAC,W;;GAEP;;AACA,SAASC,UAAT,CAAqBC,GAArB,EAA0B;AACxB,SAAOA,GAAG,CAACC,OAAJ,CAAY,KAAZ,EAAmB,EAAnB,CAAP;AACD;;AAED,eAAeC,kBAAf,CAAmCC,GAAnC,EAAwC;AACtC,MAAIA,GAAG,CAACC,MAAJ,KAAe,GAAnB,EAAwB;AACtB,UAAM,IAAIP,SAAJ,EAAN;AACD;;AAED,QAAMQ,WAAW,GAAGF,GAAG,CAACG,IAAJ,EAApB;;AAEA,MAAIH,GAAG,CAACC,MAAJ,GAAa,GAAb,IAAoBD,GAAG,CAACC,MAAJ,GAAa,GAArC,EAA0C;AACxC,QAAIG,MAAM,GAAI,+BAA8BJ,GAAG,CAACC,MAAO,KAAID,GAAG,CAACK,UAAW,EAA1E;;AACA,QAAI;AACF,YAAMC,OAAO,GAAG,MAAMJ,WAAtB;AACAE,MAAAA,MAAM,GAAGE,OAAO,CAACC,OAAR,GAAmB,GAAEH,MAAO,aAAYE,OAAO,CAACC,OAAQ,EAAxD,GAA4DH,MAArE;AACAA,MAAAA,MAAM,GAAGE,OAAO,CAACE,SAAR,GAAqB,GAAEJ,MAAO,gBAAeE,OAAO,CAACE,SAAU,EAA/D,GAAmEJ,MAA5E;AACD,KAJD,SAIU;AACR;AACA,YAAM,IAAIK,KAAJ,CAAUL,MAAV,CAAN;AACD;AACF;;AACD,SAAOF,WAAP;AACD;;;;;;;;;;cAsBEQ,MAAM,CAACC,GAAP,CAAW,gCAAX,C;;AApBY,MAAMC,aAAN,CAAoB;AAOjCC,EAAAA,WAAW,CAAEC,IAAF,EAAQC,IAAR,EAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAFFC,IAAI,IAAIC,QAAQ,IAAKD,IAAI,GAAGC,QAAH,GAAc,KAAKC,iBAAL,CAAuBD,QAAvB;AAErC;AACvB,SAAKH,IAAL,GAAYA,IAAZ;AACA,SAAKC,IAAL,GAAYA,IAAZ;AACA,SAAKG,iBAAL,GAAyB,KAAKA,iBAAL,CAAuBC,IAAvB,CAA4B,IAA5B,CAAzB;AACA,SAAKC,cAAL,GAAsB,CAAC,QAAD,EAAW,cAAX,EAA2B,iBAA3B,CAAtB;AACA,SAAKC,aAAL,GAAqB,KAArB;AACA,8EAAyBN,IAAzB,oBAAyBA,IAAI,CAAEO,gBAA/B;AACD;;AAEDC,EAAAA,mBAAmB,CAAEC,OAAF,EAAW;AAC5B,8EAAyBA,OAAzB;AACD;;AAED,kBAAkD;AAAE,uCAAO,IAAP;AAA+B;;AAEvE,MAARC,QAAQ,GAAI;AACd,UAAM;AAAEC,MAAAA;AAAF,QAAgB,KAAKZ,IAAL,CAAUa,QAAV,EAAtB;AACA,UAAMC,IAAI,GAAG,KAAKb,IAAL,CAAUc,YAAvB;AACA,WAAOjC,UAAU,CAAC8B,SAAS,IAAIA,SAAS,CAACE,IAAD,CAAtB,GAA+BF,SAAS,CAACE,IAAD,CAAxC,GAAiDA,IAAlD,CAAjB;AACD;;AAQDJ,EAAAA,OAAO,GAAI;AACT,WAAOM,OAAO,CAACC,OAAR,CAAgB,EACrB,GAAGnB,aAAa,CAACoB,cADI;AAErB,qCAAG,IAAH;AAFqB,KAAhB,CAAP;AAID;;AAEDd,EAAAA,iBAAiB,CAAED,QAAF,EAAY;AAC3B,UAAMgB,KAAK,GAAG,KAAKnB,IAAL,CAAUa,QAAV,EAAd;AACA,UAAMD,SAAS,GAAGO,KAAK,CAACP,SAAN,IAAmB,EAArC;AACA,UAAME,IAAI,GAAG,KAAKb,IAAL,CAAUc,YAAvB;AACA,UAAM;AAAEL,MAAAA;AAAF,QAAcP,QAApB,CAJ2B,CAK3B;;AACA,QAAIO,OAAO,CAACU,GAAR,CAAY,MAAZ,KAAuBV,OAAO,CAACW,GAAR,CAAY,MAAZ,MAAwBT,SAAS,CAACE,IAAD,CAA5D,EAAoE;AAClE,WAAKd,IAAL,CAAUsB,QAAV,CAAmB;AACjBV,QAAAA,SAAS,EAAE,EAAE,GAAGA,SAAL;AAAgB,WAACE,IAAD,GAAQJ,OAAO,CAACW,GAAR,CAAY,MAAZ;AAAxB;AADM,OAAnB;AAGD;;AACD,WAAOlB,QAAP;AACD;;AAmBDoB,EAAAA,SAAS,CAAEC,IAAF,EAAQ;AACf,QAAI,KAAKjB,aAAT,EAAwB;AACtB,aAAOS,OAAO,CAACC,OAAR,CAAgB,KAAKX,cAAL,CAAoBmB,KAApB,EAAhB,CAAP;AACD;;AAED,WAAOC,KAAK,6BAAC,IAAD,oBAAcF,IAAd,GAAqB;AAC/BG,MAAAA,MAAM,EAAE;AADuB,KAArB,CAAL,CAGJC,IAHI,CAGEzB,QAAD,IAAc;AAClB,UAAIA,QAAQ,CAACO,OAAT,CAAiBU,GAAjB,CAAqB,8BAArB,CAAJ,EAA0D;AACxD,aAAKd,cAAL,GAAsBH,QAAQ,CAACO,OAAT,CAAiBW,GAAjB,CAAqB,8BAArB,EACnBQ,KADmB,CACb,GADa,EACRC,GADQ,CACHC,UAAD,IAAgBA,UAAU,CAACC,IAAX,GAAkBC,WAAlB,EADZ,CAAtB;AAED;;AACD,WAAK1B,aAAL,GAAqB,IAArB;AACA,aAAO,KAAKD,cAAL,CAAoBmB,KAApB,EAAP;AACD,KAVI,EAWJS,KAXI,CAWGC,GAAD,IAAS;AACd,WAAKnC,IAAL,CAAUoC,GAAV,CAAe,sDAAqDD,GAAI,EAAxE,EAA2E,SAA3E;AACA,WAAK5B,aAAL,GAAqB,IAArB;AACA,aAAO,KAAKD,cAAL,CAAoBmB,KAApB,EAAP;AACD,KAfI,CAAP;AAgBD;;AAEDY,EAAAA,mBAAmB,CAAEb,IAAF,EAAQ;AACzB,WAAOR,OAAO,CAACsB,GAAR,CAAY,CAAC,KAAKf,SAAL,CAAeC,IAAf,CAAD,EAAuB,KAAKd,OAAL,EAAvB,CAAZ,EACJkB,IADI,CACC,QAA+B;AAAA,UAA9B,CAACtB,cAAD,EAAiBI,OAAjB,CAA8B;AACnC;AACA6B,MAAAA,MAAM,CAACC,IAAP,CAAY9B,OAAZ,EAAqB+B,OAArB,CAA8BC,MAAD,IAAY;AACvC,YAAI,CAACpC,cAAc,CAACqC,QAAf,CAAwBD,MAAM,CAACT,WAAP,EAAxB,CAAL,EAAoD;AAClD,eAAKjC,IAAL,CAAUoC,GAAV,CAAe,iDAAgDM,MAAO,EAAtE;AACA,iBAAOhC,OAAO,CAACgC,MAAD,CAAd,CAFkD,CAE3B;AACxB;AACF,OALD;AAOA,aAAOhC,OAAP;AACD,KAXI,CAAP;AAYD;;AAEDW,EAAAA,GAAG,CAAEG,IAAF,EAAQoB,gBAAR,EAA0B;AAC3B,UAAMjB,MAAM,GAAG,KAAf;AACA,WAAO,KAAKU,mBAAL,CAAyBb,IAAzB,EACJI,IADI,CACElB,OAAD,IAAahC,qBAAqB,6BAAC,IAAD,oBAAc8C,IAAd,GAAqB;AAC3DG,MAAAA,MAD2D;AAE3DjB,MAAAA,OAF2D;AAG3DmC,MAAAA,WAAW,EAAE,KAAK5C,IAAL,CAAU6C,oBAAV,IAAkC;AAHY,KAArB,CADnC,EAMJlB,IANI,6BAMC,IAND,8CAM2BgB,gBAN3B,GAOJhB,IAPI,CAOC3C,kBAPD,EAQJiD,KARI,6BAQE,IARF,gCAQqBP,MARrB,EAQ6BH,IAR7B,EAAP;AASD;;AAEDuB,EAAAA,IAAI,CAAEvB,IAAF,EAAQwB,IAAR,EAAcJ,gBAAd,EAAgC;AAClC,UAAMjB,MAAM,GAAG,MAAf;AACA,WAAO,KAAKU,mBAAL,CAAyBb,IAAzB,EACJI,IADI,CACElB,OAAD,IAAahC,qBAAqB,6BAAC,IAAD,oBAAc8C,IAAd,GAAqB;AAC3DG,MAAAA,MAD2D;AAE3DjB,MAAAA,OAF2D;AAG3DmC,MAAAA,WAAW,EAAE,KAAK5C,IAAL,CAAU6C,oBAAV,IAAkC,aAHY;AAI3DG,MAAAA,IAAI,EAAEC,IAAI,CAACC,SAAL,CAAeH,IAAf;AAJqD,KAArB,CADnC,EAOJpB,IAPI,6BAOC,IAPD,8CAO2BgB,gBAP3B,GAQJhB,IARI,CAQC3C,kBARD,EASJiD,KATI,6BASE,IATF,gCASqBP,MATrB,EAS6BH,IAT7B,EAAP;AAUD;;AAED4B,EAAAA,MAAM,CAAE5B,IAAF,EAAQwB,IAAR,EAAcJ,gBAAd,EAAgC;AACpC,UAAMjB,MAAM,GAAG,QAAf;AACA,WAAO,KAAKU,mBAAL,CAAyBb,IAAzB,EACJI,IADI,CACElB,OAAD,IAAahC,qBAAqB,CAAE,GAAE,KAAKiC,QAAS,IAAGa,IAAK,EAA1B,EAA6B;AACnEG,MAAAA,MADmE;AAEnEjB,MAAAA,OAFmE;AAGnEmC,MAAAA,WAAW,EAAE,KAAK5C,IAAL,CAAU6C,oBAAV,IAAkC,aAHoB;AAInEG,MAAAA,IAAI,EAAED,IAAI,GAAGE,IAAI,CAACC,SAAL,CAAeH,IAAf,CAAH,GAA0B;AAJ+B,KAA7B,CADnC,EAOJpB,IAPI,6BAOC,IAPD,8CAO2BgB,gBAP3B,GAQJhB,IARI,CAQC3C,kBARD,EASJiD,KATI,6BASE,IATF,gCASqBP,MATrB,EAS6BH,IAT7B,EAAP;AAUD;;AArJgC;;kBAuDxBzC,G,EAAK;AACZ,MAAI,kBAAkBsE,IAAlB,CAAuBtE,GAAvB,CAAJ,EAAiC;AAC/B,WAAOA,GAAP;AACD;;AACD,SAAQ,GAAE,KAAK4B,QAAS,IAAG5B,GAAI,EAA/B;AACD;;wBAEc4C,M,EAAQH,I,EAAM;AAC3B,SAAQW,GAAD,IAAS;AAAA;;AACd,QAAI,UAACA,GAAD,aAAC,KAAKmB,WAAN,CAAJ,EAAuB;AACrB;AACAnB,MAAAA,GAAG,GAAG,IAAIxD,cAAJ,CAAoB,aAAYgD,MAAO,IAApB,4BAAuB,IAAvB,oBAAoCH,IAApC,CAA0C,EAA7D,EAAgE;AAAE+B,QAAAA,KAAK,EAAEpB;AAAT,OAAhE,CAAN;AACD;;AACD,WAAOnB,OAAO,CAACwC,MAAR,CAAerB,GAAf,CAAP;AACD,GAND;AAOD;;AAtEkBrC,a,CACZ2D,O,GAAU5E,WAAW,CAAC6E,O;AADV5D,a,CA4BZoB,c,GAAiB;AACtByC,EAAAA,MAAM,EAAE,kBADc;AAEtB,kBAAgB,kBAFM;AAGtB,mBAAkB,0BAAyB7D,aAAa,CAAC2D,OAAQ;AAH3C,C;iBA5BL3D,a","sourcesContent":["'use strict'\n\nimport fetchWithNetworkError from '@uppy/utils/lib/fetchWithNetworkError'\nimport ErrorWithCause from '@uppy/utils/lib/ErrorWithCause'\nimport AuthError from './AuthError.js'\n\nimport packageJson from '../package.json'\n\n// Remove the trailing slash so we can always safely append /xyz.\nfunction stripSlash (url) {\n  return url.replace(/\\/$/, '')\n}\n\nasync function handleJSONResponse (res) {\n  if (res.status === 401) {\n    throw new AuthError()\n  }\n\n  const jsonPromise = res.json()\n\n  if (res.status < 200 || res.status > 300) {\n    let errMsg = `Failed request with status: ${res.status}. ${res.statusText}`\n    try {\n      const errData = await jsonPromise\n      errMsg = errData.message ? `${errMsg} message: ${errData.message}` : errMsg\n      errMsg = errData.requestId ? `${errMsg} request-Id: ${errData.requestId}` : errMsg\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      throw new Error(errMsg)\n    }\n  }\n  return jsonPromise\n}\n\nexport default class RequestClient {\n  static VERSION = packageJson.version\n\n  #companionHeaders\n\n  #getPostResponseFunc = skip => response => (skip ? response : this.onReceiveResponse(response))\n\n  constructor (uppy, opts) {\n    this.uppy = uppy\n    this.opts = opts\n    this.onReceiveResponse = this.onReceiveResponse.bind(this)\n    this.allowedHeaders = ['accept', 'content-type', 'uppy-auth-token']\n    this.preflightDone = false\n    this.#companionHeaders = opts?.companionHeaders\n  }\n\n  setCompanionHeaders (headers) {\n    this.#companionHeaders = headers\n  }\n\n  [Symbol.for('uppy test: getCompanionHeaders')] () { return this.#companionHeaders }\n\n  get hostname () {\n    const { companion } = this.uppy.getState()\n    const host = this.opts.companionUrl\n    return stripSlash(companion && companion[host] ? companion[host] : host)\n  }\n\n  static defaultHeaders = {\n    Accept: 'application/json',\n    'Content-Type': 'application/json',\n    'Uppy-Versions': `@uppy/companion-client=${RequestClient.VERSION}`,\n  }\n\n  headers () {\n    return Promise.resolve({\n      ...RequestClient.defaultHeaders,\n      ...this.#companionHeaders,\n    })\n  }\n\n  onReceiveResponse (response) {\n    const state = this.uppy.getState()\n    const companion = state.companion || {}\n    const host = this.opts.companionUrl\n    const { headers } = response\n    // Store the self-identified domain name for the Companion instance we just hit.\n    if (headers.has('i-am') && headers.get('i-am') !== companion[host]) {\n      this.uppy.setState({\n        companion: { ...companion, [host]: headers.get('i-am') },\n      })\n    }\n    return response\n  }\n\n  #getUrl (url) {\n    if (/^(https?:|)\\/\\//.test(url)) {\n      return url\n    }\n    return `${this.hostname}/${url}`\n  }\n\n  #errorHandler (method, path) {\n    return (err) => {\n      if (!err?.isAuthError) {\n        // eslint-disable-next-line no-param-reassign\n        err = new ErrorWithCause(`Could not ${method} ${this.#getUrl(path)}`, { cause: err })\n      }\n      return Promise.reject(err)\n    }\n  }\n\n  preflight (path) {\n    if (this.preflightDone) {\n      return Promise.resolve(this.allowedHeaders.slice())\n    }\n\n    return fetch(this.#getUrl(path), {\n      method: 'OPTIONS',\n    })\n      .then((response) => {\n        if (response.headers.has('access-control-allow-headers')) {\n          this.allowedHeaders = response.headers.get('access-control-allow-headers')\n            .split(',').map((headerName) => headerName.trim().toLowerCase())\n        }\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n      .catch((err) => {\n        this.uppy.log(`[CompanionClient] unable to make preflight request ${err}`, 'warning')\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n  }\n\n  preflightAndHeaders (path) {\n    return Promise.all([this.preflight(path), this.headers()])\n      .then(([allowedHeaders, headers]) => {\n        // filter to keep only allowed Headers\n        Object.keys(headers).forEach((header) => {\n          if (!allowedHeaders.includes(header.toLowerCase())) {\n            this.uppy.log(`[CompanionClient] excluding disallowed header ${header}`)\n            delete headers[header] // eslint-disable-line no-param-reassign\n          }\n        })\n\n        return headers\n      })\n  }\n\n  get (path, skipPostResponse) {\n    const method = 'get'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(this.#getUrl(path), {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n\n  post (path, data, skipPostResponse) {\n    const method = 'post'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(this.#getUrl(path), {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n        body: JSON.stringify(data),\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n\n  delete (path, data, skipPostResponse) {\n    const method = 'delete'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(`${this.hostname}/${path}`, {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n        body: data ? JSON.stringify(data) : null,\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n}\n"]}